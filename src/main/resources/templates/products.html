<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="'Resultados para: ' + ${param.name[0]} + ' - Total Electro'">Resultados da Busca - Total Electro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilo com√∫n para los botones "Carrinho", "Sair" y "Minha conta" (igual que "Buscar") */
        .header-btn {
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
        }

        /* Estilos para o bot√£o de adicionar ao carrinho */
        .add-to-cart-btn {
            background: linear-gradient(135deg, #f36f21 0%, #e05a0c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .add-to-cart-btn:hover {
            background: linear-gradient(135deg, #e05a0c 0%, #d1520a 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(243, 111, 33, 0.3);
        }

        .add-to-cart-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .add-to-cart-btn.loading {
            position: relative;
            color: transparent;
        }

        .add-to-cart-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Toast de notifica√ß√£o */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            border-left: 4px solid;
            min-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #28a745;
            color: #155724;
        }

        .toast.error {
            border-left-color: #dc3545;
            color: #721c24;
        }

        .toast .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .toast .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.5;
        }

        .toast .toast-close:hover {
            opacity: 1;
        }

        /* Melhorias no product card */
        .product {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Estilo melhorado para o bot√£o "Ver Detalhes" */
        .product .btn-comprar {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #333;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: center;
            width: 100%;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .product .btn-comprar:hover {
            background: linear-gradient(135deg, #f36f21 0%, #e05a0c 100%);
            color: white;
            border-color: #f36f21;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(243, 111, 33, 0.25);
            text-decoration: none;
        }

        .product .btn-comprar:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .product .btn-comprar:hover:before {
            left: 100%;
        }

        /* Estilo para o √≠cone no bot√£o "Ver Detalhes" */
        .product .btn-comprar::after {
            content: '';
            margin-left: 0.3rem;
            font-size: 0.9rem;
        }

        .product .btn-comprar:hover::after {
            content: '';
        }

        /* Melhorias na imagem do produto */
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product:hover .product-image {
            transform: scale(1.05);
        }

        /* Melhorias no nome e pre√ßo do produto */
        .product h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0.5rem;
            color: #333;
            line-height: 1.3;
            height: 2.6rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product .price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f36f21;
            margin: 0 0.5rem 0.5rem 0.5rem;
        }

        /* Melhorias no container dos produtos */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        /* Melhorias nos bot√µes de a√ß√£o do produto */
        .product-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem;
        }

        /* Container do conte√∫do do produto */
        .product-content {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Melhorias no bot√£o de favoritar */
        .product .fav {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: #ff4444;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product .fav:hover {
            background: #ff4444;
            color: white;
            transform: scale(1.1);
        }

        /* Placeholder para imagem n√£o dispon√≠vel */
        .product .no-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- HEADER -->
    <div class="top-header">
        <div class="logo-header">
            <a href="/"><img th:src="@{/images/logo.png}" alt="Total Electro"></a>
        </div>
        <div class="search-bar">
            <form th:action="@{/product/search}" method="get">
                <input type="text" name="name" th:value="${param.name[0]}" placeholder="Pesquisar...">
                <button type="submit">Buscar</button>
            </form>
        </div>
        <div class="header-actions">
            <button class="lang">üáßüá∑ <span class="material-symbols-outlined">keyboard_arrow_down</span></button>
            <a th:href="${#authorization.expression('isAuthenticated()')} ? @{/profile} : @{/login}" class="account header-btn">Minha conta</a>
            <a th:href="@{/cart}" class="cart header-btn" id="cart-link">
                <img th:src="@{/images/cart-outline.png}" alt="Carrinho">
                <span class="cart-count" id="cartCount">0</span>
            </a>
        </div>
    </div>

    <!-- MENU -->
    <nav class="main-menu">
        <div class="menu-items">
            <a th:href="@{/product/category/iluminacion}">Ilumina√ß√£o</a>
            <a th:href="@{/product/category/cables-y-accessorios}">Cabos e acess√≥rios</a>
            <a th:href="@{/product/category/herramientas-electricas}">Ferramentas el√©tricas</a>
            <a th:href="@{/product/category/automatizacion-y-domoticas}">Automa√ß√£o e dom√≥tica</a>
            <a th:href="@{/product/category/seguridad-electrica}">Seguran√ßa el√©trica</a>
        </div>
        <div class="menu-offers">
            <button>Ofertas e promo√ß√µes</button>
        </div>
    </nav>

    <!-- RESULTADOS DA BUSCA -->
    <div class="search-results">
        <h1>Resultados para: <span th:text="${param.name[0]}">termo de busca</span></h1>
        
        <!-- FILTROS -->
        <div class="filters">
            <div class="filter-group">
                <h3>Pre√ßo</h3>
                <div class="price-range">
                    <input type="range" min="0" max="1000" value="500">
                    <div class="price-inputs">
                        <input type="number" placeholder="Min">
                        <input type="number" placeholder="Max">
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <h3>Categoria</h3>
                <div class="checkbox-group">
                    <label><input type="checkbox"> Ilumina√ß√£o</label>
                    <label><input type="checkbox"> Cabos e acess√≥rios</label>
                    <label><input type="checkbox"> Ferramentas el√©tricas</label>
                    <label><input type="checkbox"> Automa√ß√£o e dom√≥tica</label>
                    <label><input type="checkbox"> Seguran√ßa el√©trica</label>
                </div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="products-grid">
            <div class="product" th:each="product : ${page.content}">
                <span class="fav">&#10084;</span>
                <img th:if="${product.imageUrl != null}" 
                     th:src="${product.imageUrl}" 
                     th:alt="${product.name}"
                     class="product-image">
                <div th:unless="${product.imageUrl != null}" class="no-image">
                    <i class="bi bi-image"></i>
                </div>
                <div class="product-content">
                    <h3 th:text="${product.name}">Nome do produto</h3>
                    <span class="price" th:text="'R$ ' + ${product.price}">R$ 0,00</span>
                    <div class="product-actions">
                        <a th:href="@{/product/{id}(id=${product.id})}" class="btn-comprar">Ver Detalhes</a>
                        <button class="add-to-cart-btn" 
                                th:data-product-id="${product.id}"
                                th:data-product-name="${product.name}"
                                onclick="addToCart(this)">
                            <i class="fas fa-shopping-cart"></i>
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGINA√á√ÉO -->
        <div class="pagination" th:if="${pagination != null}">
            <a th:each="page : ${pagination}" 
               th:href="@{/product/search(name=${param.name[0]}, page=${page})}"
               th:text="${page}"
               th:class="${page == #numbers.formatDecimal(page, 0, 0)} ? 'active' : ''">
            </a>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <strong>Informa√ß√µes de contato</strong><br>
                Rivera<br>
                Sarand√≠ 821, 40000, Rivera, Uruguai<br>
                Tel.: +598 4623 5798<br>
                Email: total-electro@gmail.com
            </div>
            <div class="footer-col footer-logo-social">
                <img th:src="@{/images/logo.png}" alt="Total Electro">
                <div class="footer-socials">
                    <img th:src="@{/images/social/facebook.png}" alt="Facebook">
                    <img th:src="@{/images/social/instagram.png}" alt="Instagram">
                    <img th:src="@{/images/social/whatsapp.png}" alt="WhatsApp">
                </div>
            </div>
            <div class="footer-col">
                <strong>Perguntas frequentes</strong><br>
                Formas de pagamento:<br>
                <span class="footer-payments">
                    <img th:src="@{/images/payments/visa.png}" alt="Visa">
                    <img th:src="@{/images/payments/mastercard.png}" alt="Mastercard">
                </span>
            </div>
        </div>
        <div class="footer-bottom">
            <span>&copy; 2024 Total Electro</span>
            <span>Todos os direitos reservados</span>
        </div>
    </footer>

    <script>
        // Fun√ß√£o para adicionar produto ao carrinho
        function addToCart(button) {
            const productId = button.dataset.productId;
            const productName = button.dataset.productName;
            
            console.log('Tentando adicionar produto ao carrinho:', { productId, productName });
            
            // Adicionar estado de loading
            button.classList.add('loading');
            button.disabled = true;
            
            // Obter o token CSRF se estiver usando Spring Security
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
            
            const headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
            };
            
            // Adicionar CSRF token se dispon√≠vel
            if (csrfToken && csrfHeader) {
                headers[csrfHeader.content] = csrfToken.content;
            }
            
            console.log('Fazendo requisi√ß√£o para /cart/add');
            
            fetch('/cart/add', {
                method: 'POST',
                headers: headers,
                body: `productId=${productId}&quantity=1`
            })
            .then(response => {
                console.log('Resposta recebida:', response.status, response.statusText);
                return response.text();
            })
            .then(data => {
                console.log('Dados da resposta:', data);
                button.classList.remove('loading');
                button.disabled = false;
                
                if (data.startsWith('success')) {
                    const cartCount = data.split(':')[1];
                    updateCartCount(cartCount);
                    showToast('success', 'Produto adicionado!', `${productName} foi adicionado ao carrinho.`);
                } else if (data.startsWith('error')) {
                    const errorMessage = data.split(':')[1];
                    console.error('Erro do servidor:', errorMessage);
                    if (errorMessage.includes('logado')) {
                        showToast('error', 'Login necess√°rio', 'Voc√™ precisa estar logado para adicionar produtos ao carrinho.');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else {
                        showToast('error', 'Erro', errorMessage);
                    }
                } else {
                    console.error('Resposta inesperada:', data);
                    showToast('error', 'Erro', 'Resposta inesperada do servidor');
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o:', error);
                button.classList.remove('loading');
                button.disabled = false;
                showToast('error', 'Erro', 'Erro ao adicionar produto ao carrinho: ' + error.message);
            });
        }

        // Fun√ß√£o para atualizar contador do carrinho
        function updateCartCount(count) {
            const cartCountElement = document.getElementById('cartCount');
            if (cartCountElement) {
                cartCountElement.textContent = count;
                
                // Anima√ß√£o de destaque
                cartCountElement.style.transform = 'scale(1.5)';
                cartCountElement.style.background = '#28a745';
                setTimeout(() => {
                    cartCountElement.style.transform = 'scale(1)';
                    cartCountElement.style.background = '#fff';
                }, 300);
            }
        }

        // Fun√ß√£o para mostrar toast de notifica√ß√£o
        function showToast(type, title, message) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${title}</span>
                    <button class="toast-close" onclick="hideToast(this)">&times;</button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Mostrar toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto-hide ap√≥s 5 segundos
            setTimeout(() => {
                hideToast(toast.querySelector('.toast-close'));
            }, 5000);
        }

        // Fun√ß√£o para esconder toast
        function hideToast(button) {
            const toast = button.closest('.toast');
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Carregar contador do carrinho ao iniciar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina carregada, buscando contador do carrinho...');
            fetch('/cart/count')
                .then(response => {
                    console.log('Resposta do contador:', response.status);
                    return response.text();
                })
                .then(count => {
                    console.log('Contador do carrinho:', count);
                    updateCartCount(count);
                })
                .catch(error => {
                    console.error('Erro ao carregar contador do carrinho:', error);
                });
        });
    </script>
</body>
</html> 